# 🔧 إصلاح نظام التتبع على الويب

## ✅ المشكلة التي تم إصلاحها

كان التطبيق يستخدم IP خاص بالموبايل (`192.168.2.2:3000`) عند التشغيل على الويب، مما يمنع الاتصال بالخادم.

## 🛠️ الحل المُطبق

تم تعديل ملف `supervisor_home_screen.dart` ليكتشف المنصة تلقائياً:

```dart
// في الويب: استخدام localhost
if (kIsWeb) {
  serverUrl = 'http://localhost:3000';
}
// في الموبايل: استخدام IP الكمبيوتر
else {
  serverUrl = 'http://192.168.2.2:3000';
}
```

## 📋 خطوات التشغيل

### 1️⃣ تشغيل الخادم (Backend)

```bash
cd C:\Users\musta\Desktop\pro\mybus\backend
node index.js
```

✅ يجب أن ترى:
```
🎉 ===========================================
🌐 API Server running on port 3000
🔌 Socket.IO Server ready
===========================================
```

### 2️⃣ تشغيل Flutter على الويب

```bash
cd C:\Users\musta\Desktop\pro\mybus
flutter run -d chrome
```

أو لتشغيل Chrome بدون قيود CORS:

```bash
flutter run -d chrome --web-browser-flag "--disable-web-security"
```

### 3️⃣ تسجيل الدخول كمشرف

1. افتح التطبيق على الويب
2. سجل دخول بحساب المشرف
3. اضغط على زر "بدء التتبع"

## 🔍 التحقق من نجاح الاتصال

### في Console المتصفح (F12):
```
🔌 منصة الويب: استخدام http://localhost:3000
✅ Socket.IO متصل بنجاح!
```

### في Console الخادم:
```
✅ عميل جديد متصل: [socket-id]
🚌 بدء تتبع باص جديد
```

## ⚙️ إعدادات إضافية

### للتشغيل على Production:

عدّل في الكود:
```dart
if (kIsWeb) {
  // غيّر localhost لعنوان خادمك الحقيقي
  serverUrl = 'https://your-server.com:3000';
}
```

### للموبايل على نفس الشبكة:

1. احصل على IP جهازك:
   - **Windows**: `ipconfig` في CMD
   - **Mac/Linux**: `ifconfig` في Terminal

2. عدّل في الكود:
```dart
else {
  serverUrl = 'http://YOUR_IP_HERE:3000'; // مثال: 192.168.1.100
}
```

## 🐛 حل المشاكل الشائعة

### ❌ "Failed to connect to server"

**الحل:**
1. تأكد أن الخادم يعمل (`node index.js`)
2. تحقق من البورت 3000 غير مشغول:
```bash
netstat -ano | findstr :3000
```

### ❌ "CORS Error"

**الحل:**
شغّل Chrome بدون CORS:
```bash
flutter run -d chrome --web-browser-flag "--disable-web-security"
```

### ❌ "غير متصل بالخادم"

**الحل:**
1. افتح DevTools (F12)
2. اذهب لتبويب Console
3. ابحث عن أخطاء Socket.IO
4. تأكد من العنوان الصحيح

## 📱 الفرق بين الموبايل والويب

| المنصة | عنوان الخادم | سبب الاختلاف |
|--------|-------------|--------------|
| 🌐 الويب | `localhost:3000` | الويب يعمل على نفس الجهاز |
| 📱 الموبايل | `192.168.x.x:3000` | الموبايل على شبكة مختلفة |

## ✨ ميزات التتبع

بعد الاتصال بنجاح، ستتمكن من:

- ✅ بدء التتبع المباشر
- ✅ إيقاف التتبع
- ✅ مشاهدة عدد الطلاب في الباص
- ✅ مشاهدة عدد تحديثات الموقع
- ✅ حالة الاتصال بالخادم

## 🎯 اختبار سريع

1. شغّل الخادم
2. شغّل التطبيق على الويب
3. سجل دخول كمشرف
4. اضغط "بدء التتبع"
5. انتظر رسالة "✅ تم بدء التتبع المباشر"

---

## 📞 إذا استمرت المشكلة

تحقق من:
- [ ] الخادم يعمل ولا توجد أخطاء
- [ ] البورت 3000 متاح
- [ ] Firebase متصل بشكل صحيح
- [ ] لا توجد أخطاء في Console المتصفح
- [ ] Chrome لا يحجب الاتصال

---

✅ **تم الإصلاح بنجاح!** جرب الآن وأخبرني بالنتيجة.
