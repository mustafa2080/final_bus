# نظام الإشعارات - كيدز باص

## نظرة عامة

تم تطوير نظام إشعارات شامل ومحسن لتطبيق كيدز باص يضمن وصول الإشعارات للمستخدمين حتى عندما يكون التطبيق مغلقاً أو في الخلفية.

## الملفات الرئيسية

### 1. UnifiedNotificationService
- **المسار**: `lib/services/unified_notification_service.dart`
- **الوظيفة**: الخدمة الرئيسية لإدارة جميع أنواع الإشعارات
- **المميزات**:
  - إدارة قنوات الإشعارات المتعددة
  - دعم الإشعارات المحلية والبعيدة
  - تخصيص الأصوات والألوان
  - حفظ FCM Token تلقائياً

### 2. FCM Background Handler
- **المسار**: `lib/services/fcm_background_handler.dart`
- **الوظيفة**: معالجة الإشعارات في الخلفية
- **المميزات**:
  - عرض الإشعارات حتى لو كان التطبيق مغلقاً
  - حفظ الإشعارات في التخزين المحلي
  - تخصيص الإشعارات حسب نوع المستخدم

### 3. AuthService المحسن
- **المسار**: `lib/services/auth_service.dart`
- **المميزات الجديدة**:
  - حفظ تسجيل الدخول باستخدام SharedPreferences
  - التحقق من صحة الجلسة عند بدء التطبيق
  - إرسال إشعار ترحيب عند تسجيل الدخول

### 4. Notification Test Helper
- **المسار**: `lib/utils/notification_test_helper.dart`
- **الوظيفة**: أدوات اختبار نظام الإشعارات
- **المميزات**:
  - اختبار جميع أنواع الإشعارات
  - اختبار سريع وشامل
  - عرض معلومات النظام

### 5. Notification Config
- **المسار**: `lib/config/notification_config.dart`
- **الوظيفة**: إعدادات مركزية للإشعارات
- **يحتوي على**: الثوابت، الألوان، الأصوات، معرفات القنوات

## قنوات الإشعارات

### 1. القناة الرئيسية (`mybus_notifications`)
- **الاستخدام**: الإشعارات العامة
- **اللون**: أزرق (#1E88E5)
- **الأولوية**: عالية

### 2. قناة الطلاب (`student_notifications`)
- **الاستخدام**: إشعارات متعلقة بالطلاب
- **اللون**: أخضر (#4CAF50)
- **الأولوية**: عالية

### 3. قناة الباص (`bus_notifications`)
- **الاستخدام**: إشعارات الركوب والنزول
- **اللون**: برتقالي (#FF9800)
- **الأولوية**: عالية

### 4. قناة الطوارئ (`emergency_notifications`)
- **الاستخدام**: تنبيهات الطوارئ
- **اللون**: أحمر (#F44336)
- **الأولوية**: قصوى

### 5. قناة الإدارة (`admin_notifications`)
- **الاستخدام**: إشعارات إدارية
- **اللون**: بنفسجي (#9C27B0)
- **الأولوية**: عالية

## الملفات المساعدة

### Android Configuration
- **AndroidManifest.xml**: إعدادات الأذونات والخدمات
- **MyFirebaseMessagingService.java**: خدمة FCM مخصصة
- **MainApplication.java**: تطبيق Android الرئيسي
- **colors.xml**: ألوان الإشعارات
- **ic_notification.xml**: أيقونة الإشعارات

## كيفية الاستخدام

### 1. تهيئة النظام
```dart
final notificationService = UnifiedNotificationService();
await notificationService.initialize();
```

### 2. إرسال إشعار محلي
```dart
await notificationService.showLocalNotification(
  title: 'عنوان الإشعار',
  body: 'محتوى الإشعار',
  channelId: 'mybus_notifications',
);
```

### 3. اختبار النظام
```dart
// اختبار سريع
await NotificationTestHelper.quickTest();

// اختبار شامل
await NotificationTestHelper.runFullNotificationTest();
```

### 4. إرسال إشعار ترحيب
```dart
await notificationService.sendWelcomeNotification('اسم المستخدم');
```

## المميزات الرئيسية

### ✅ الإشعارات الخارجية
- تظهر الإشعارات حتى لو كان التطبيق مغلقاً
- دعم الإشعارات في الخلفية
- معالجة خاصة للإشعارات عند إعادة تشغيل الجهاز

### ✅ حفظ تسجيل الدخول
- حفظ تلقائي لبيانات تسجيل الدخول
- التحقق من صحة الجلسة عند بدء التطبيق
- انتهاء صلاحية الجلسة بعد 30 يوم

### ✅ تخصيص الإشعارات
- أصوات مختلفة حسب نوع الإشعار
- ألوان مميزة لكل قناة
- أيقونات مخصصة
- نمط اهتزاز متنوع

### ✅ إدارة متقدمة
- حفظ تاريخ الإشعارات
- إحصائيات الإرسال والاستلام
- أدوات اختبار شاملة
- تسجيل مفصل للأخطاء

## الاختبار

### من لوحة الإدارة
1. اذهب إلى الصفحة الرئيسية للإدارة
2. اضغط على "اختبار الإشعارات"
3. اختر نوع الاختبار المطلوب

### من الكود
```dart
// اختبار سريع
await NotificationTestHelper.quickTest();

// اختبار مع صورة
await NotificationTestHelper.testNotificationWithImage();

// عرض معلومات النظام
NotificationTestHelper.printSystemInfo();
```

## استكشاف الأخطاء

### مشاكل شائعة وحلولها

#### 1. الإشعارات لا تظهر
- تأكد من منح أذونات الإشعارات
- تحقق من إعدادات تحسين البطارية
- راجع سجلات التطبيق

#### 2. الإشعارات لا تظهر في الخلفية
- تأكد من تسجيل background handler
- تحقق من إعدادات Android Manifest
- راجع خدمة FCM

#### 3. مشاكل الصوت
- تأكد من وجود ملفات الصوت
- تحقق من أذونات الصوت
- راجع إعدادات القناة

## التطوير المستقبلي

### مميزات مخططة
- [ ] إشعارات مجدولة
- [ ] إشعارات جماعية محسنة
- [ ] تحليلات الإشعارات
- [ ] إشعارات تفاعلية
- [ ] دعم الإشعارات الغنية (Rich Notifications)

### تحسينات مقترحة
- [ ] ضغط الإشعارات المتشابهة
- [ ] إعدادات مستخدم مخصصة
- [ ] إشعارات ذكية حسب الموقع
- [ ] تكامل مع الساعات الذكية

## الدعم الفني

للحصول على المساعدة أو الإبلاغ عن مشاكل:
1. راجع سجلات التطبيق أولاً
2. استخدم أدوات الاختبار المدمجة
3. تحقق من إعدادات الجهاز
4. راجع هذا الدليل للحلول الشائعة

---

**ملاحظة**: هذا النظام تم تطويره خصيصاً لتطبيق كيدز باص ويدعم جميع أنواع الأجهزة والإصدارات الحديثة من Android و iOS.